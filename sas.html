/* Create a fileref that executes a shell command when read from */
filename out pipe "ls -d /ruta/a/datos/*/";

/* Create a dataset named 'carpetas' with the directory names */
data carpetas;
   infile out truncover;
   input nombre $char100.;
   if substr(nombre, length(nombre)) = '/' then nombre = substr(nombre, 1, length(nombre)-1);
run;

/* Clear the 'out' fileref */
filename out clear;

/* Create a dataset to store the commands for listing files in each directory */
data commands;
    set carpetas;
    length command $200;
    command = catt('filename indata pipe "ls "', trim(nombre), '"; data _temp; retain nombre "', trim(nombre), '"; infile indata; input file_name $char100.; output; run;');
run;

/* Initialize the 'files' dataset */
data files;
    length nombre $100 file_name $100;
    stop;
run;

/* Execute the commands */
data _null_;
    set commands;
    call execute(command);
    call execute('proc append base=files data=_temp; run;');
    call execute('proc datasets library=work nolist; delete _temp; quit;');
run;
